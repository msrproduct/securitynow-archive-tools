 Bandwidth for Security Now is provided by AOL Radio at AOL.com/podcasting.
 This is Security Now with Steve Gibson, Episode 42 for June 1, 2006, Nat Proversal.
 Security Now is brought to you by Astaro, makers of the Astaro Security Gateway on the web at www.astarro.com.
 The month of June, heralds in, graduation, brides, Father's Day, and of course every month is time for every Thursday and every month is time for security now.
 Steve Gibson is here to talk about more security issues.
 Hello, Steve.
 Hey Leo, great.
 Great to be back.
 Happy June.
 And barbecuing in June, too, right?
 Barbecuing, yeah.
 June is one of my favorite months, I think because of all of those things.
 My daughter graduates from 8th grade in a few days and just the sun is shining a summary I like.
 So you promised us last week that we will talk about getting your router to behave.
 Well, or yes, what it is about routers which may or may not allow them to behave and specifically how it is that security that we've talked about.
 I mean, we talked about nat routers because we're both so bullish on nat routers from a security standpoint, the fact that a nat router makes sort of a natural hardware firewall which prevents unsolicited packets that are unsolicited, meaning they're unexpected.
 You know, the random, as I call it, IBR, internet background radiation, but it's just this noise.
 I mean, if you ever put a packet capture on a raw interface directly on a cable modem or DSL line or something, it's just amazing how much debris is for one reason or another aimed at your IP.
 Sometimes it's people scanning, you know, for, you know, the exploit du jour, whatever it is that has been recently found out.
 Sometimes it's people trying, still trying to send you messenger pop up spam.
 It's just incredible how much junk is out there.
 So, you know, people who have a personal firewall, a software firewall running on their computer, they're typically being harassed all the time until they finally get tired of that until their personal software firewall.
 Not to tell them every time one of these pieces of junk hits their computer.
 Actually, it's a sort of a feature of Windows XP service pack twos built in firewall is that it's not telling you that, oh, I just blocked something you don't care about.
 It's just, it's silent.
 And of course, all the normal personal firewalls, the traditional semantic, McAfee, zone alarm, karaoke, tiny and so forth,
 all of those typically have the option of not notifying you every time something comes in.
 You know, for people who, for whom a firewall is a new thing, it's sort of fun to say, oh, look, something just hit me.
 It's like, okay, stand outside in the rain and yeah, the same thing.
 I don't really need anything to hit me and I don't even know about it if it does.
 Exactly. So, so, so the beauty of having a Nat router up in front of your computer is that it blocks stuff, which is, which is trying to come in your connection,
 which is just from some IP, some random location that you're not expecting anything from.
 And suddenly your software firewall, if you have, if you still had one that was alerting you all the time, it just goes silent because nothing gets in.
 But the, both the advantage of the router is also, it's disadvantage when there is incoming traffic that you want.
 Well, exactly. And, and this has been the, the great problem, which, which was, I'm not sure really where the pioneering was done on this.
 It may well have been the Kazah people.
 They had to.
 Well, exactly because they were running their, their file sharing clients on people's computers who more and more often were behind Nat routers.
 Now, we should make it clear that incoming traffic is okay. It will always get through if you request it.
 It's only incoming traffic you didn't request that becomes an issue.
 Well, and then if we're going to say, well, the word request, we need to explain what that means.
 What, what, what, what a request is, well, there, I guess there are two ways you could request traffic.
 You could manually open a port, which is the traditional way of saying, I want to run a server.
 I want, for example, I want to run a web server or a, well, I was going to say email server, but that's almost impossible these days because ISPs are blocking port 25, which is what you normally use for email.
 And even web servers are now being looked at scans at by, by ISPs.
 But, but if you wanted to explicitly allow traffic to come into your system, you would need to, in, in the first case, to open what's called a static port that is create a static port.
 So that, so that, so that packets coming to your IP at that destination port will not be discarded out of hand, which your router would normally do, but instead will be permitted through and sent to a specific computer behind the router in your network,
 which you have designated as the recipient for incoming traffic on that port.
 The, the implicit way of so-called requesting traffic is just that you have, you have recently sent your own traffic outwards through the net router to some remote location.
 What that does is that creates a mapping in the router, in the router's RAM, not something that you have to do manually, it's done automatically for you, which is how net routing works, so that when data passes outwards through the net router to some remote destination,
 it, it implicitly allows return traffic from that remote destination to come back in through the router, and it will automatically be sent back to the computer behind the router that originally sent that outbound.
 So, so it essentially, it allows you to, to use the internet seamlessly connect outwards to any services and servers that you need to use, and anything that they send you will be sent back.
 But as anybody who's tried to put up a web server or an email server, any server of any kind inside his network has found, that's, it's not enough to just have outbound requests. Sometimes you want to have people coming into your system.
 Well, and a perfect instance of this is, is in a situation where, for example, you wanted to use VoIP, or frankly, if you wanted to just send a file to someone else and you had some sort of a file transfer protocol.
 So in the case of, for example, two people with, who want to have a VoIP connection, what they really want is a connection. That is, we, we know from our talking about Skype, for example, that, you know, in VoIP, the, the latency between packets, the length of time it takes for the package to go from one Skype user to another really affects the call quality
 and just the, the, the feeling of being connected. So, so what these people want, these two VoIP users is they want to be able to send data back and forth between themselves.
 Well, here's the problem. They're both behind a NAT router. The NAT router will allow data outbound, but not inbound without being reconfigured.
 And what we specifically want to do is we want to avoid that reconfiguration, because what that really means is it means opening a port so that, so that traffic can come in from anywhere, not just from the person you're trying to connect to.
 So, for example, imagine that, that the first person tries to send some data to the second. Well, that data will leave their NAT router easily. That's no problem. That's what NAT routers do. But the data is going to travel across the internet to the other person and hit their NAT router and, and die completely.
 It's unexpected data. It's unsolicited. So there's no way for it to get in. Well, what the clever guys, I think probably first at Kazah came up with was this notion of, of both people doing the same thing at the same time.
 That is, each person sends data at the other person's NAT router, and they send it from the same port that the other person's data came from. So, in fact, it might stumble a little bit at the beginning, depending upon, you know, whose packet arrives at the other person first.
 But, but the beauty is that, that the, the outgoing traffic from, or, or through each NAT router creates an expectation of return traffic. If the other person is able to design their outgoing traffic so that it looks like the expected incoming traffic for the other person's NAT router,
 it'll get through. This sounds like hacking. Well, I mean, it, it, it's some really cool stuff. I mean, we've seen people use other systems like a third party centralized server, like how Machia uses where it's, it, the, the transactions initiated as an outbound transaction for both ends and then they kind of get handshaked.
 But this eliminates, there's no third party server at all. This is a way to do peer to peer transactions without having any third party involved.
 Well, kind of. Yeah. Actually, there's no third party server involved once the connection is initiated. That is that the third party is not a relay that is relaying all the traffic between the two endpoints. But it is necessary to briefly use a third party. Some server like located out on the Internet that both of the people
 who want to connect are able to connect to. The reason is that until the, until the NAT routers have allowed each other's traffic in, they can't see the traffic that is trying to get in.
 So here's the, here's what is really going on. And this is the whole point of what makes a NAT router peer friendly or not and how this, how it's possible to knit together a conversation between two people both behind that routers.
 They, both of their applications, for example, their V.O.I. applications, send data from, from their computer to this third party. We'll call it a rendezvous server or maybe a liaison server. There's no real official designation because this is just all kind of stuff that's been created.
 So, so both people send data from them, from, from each, from themselves to this third party. The, the rendezvous server sees the, the external port number, and that's the critical information.
 They, the, the, the, the parties may know each other's public IP, which is the only way they would have of sending the data to each other in the first place. But normally you, you cannot know what port your NAT router is going to assign to the outgoing data.
 Because that's done just sort of automatically and algorithmically, and it's changing all the time. So, so it's not like web traffic where it always uses port 80. It uses a random port each time?
 Well, see that, that's it. And that's what NAT does. NAT uses a, it, it, it rewrites the packet so that it changes not only the, the source IP so that instead of coming back to your computer behind the router, it comes back to the router.
 It also changes the, it also changes the source port so that when the packet comes back to that port, the router knows this port is at the moment, it's assigned to, to this conversation on this computer behind the NAT router.
 That's the whole way NAT is able to, to disambiguate all the traffic coming, coming to it to among multiple machines that are all behind NAT.
 But now that's only for internal use. I mean, for external use, you're using the public IP address and the, and the standard canonical port like port 80. Once it's, once it's outside the router.
 Well, okay, but port 80 would be the, the destination port. It's, it, it's the traffic has its own port.
 Exactly. Okay. So this is something I didn't understand about the net. So when I'm surfing to a website without a router, I go out and ask for something at port 80, but it will come in on a different port.
 Yes. In fact, that, that, that's where we have this notion of service ports are typically numbered one through 1023 and application ports are, or client ports are start at one at 1024 and go up to 65535.
 And they're assigned randomly in each, in each session.
 Well, actually there, they tend to be assigned sequentially, just because there's really no security problem with, with, with allocated them sequentially.
 But so, so as, for example, as your, as your web browser is making connections to external servers, it'll ask the OS for a port connection.
 The OS will normally just assign the next numerical hire about port starting from 1024 and going upwards. And then, but so, so the packets that leave will contain that port number as their return.
 But actually, it's the source port, because it's the port that the source, the packet, and then, and then they'll use port 80 as the, as the destination. And so the, that's for all protocols.
 Pretty much. Well, I can't make, I can't say that.
 Many, most.
 For example, DNS, DNS generally sources its packets from port 53 and sends them to 53. So they come back to 53.
 And there are other protocols, like, like, for example, service protocols, like, like, like windows will generally source ports from 445 and then come back to 445.
 So, so no, it's not true for all protocols, but for, for, for typical computer client protocols, you know, like, like web and, and, and an email client that is connecting out to port 25 to send mail or, or to port 110 to receive mail, it'll use high numbered ports.
 I don't think you can get kazaa credit for this, because I think Microsoft had to create a directory service for its messenger.
 ICQ probably had to do something similar, didn't it, for a chat.
 All of these predate kazaa.
 This problem must have been solved by them as well, yes.
 Actually, these, they all had this problem and did not have solutions.
 Well, I know Microsoft used his directory servers at first, and I think that that's how they tried to get around it.
 So, so, so, so Nat would just normally have, have shut down those, those early, those early adopters.
 I mean, and remember that in the beginning, Nat, having a Nat router really was a lot of trouble.
 I mean, it caused problems for people who wanted these kinds of things.
 Okay, so, in order to close this topic, the, the, both people send packets to this liaison or this rendezvous server.
 It sees what port those packets came from on each Nat router.
 And it exchanges that information, sending it back to each other, that is to the other person.
 And, and then they subsequently send their data to each other using the proper port number.
 Because they've sent data outbound to the other IP and the, the, they've aimed it at the port that now they know thanks to the third party's intervention brief intervention.
 Now they know what port their, the other person's data is coming from, their packets are regarded as solicited, even though they technically aren't the returning traffic.
 Very clever.
 To each other, they look like the returning traffic and it works.
 And at that point, you've got a handshake and the rendezvous server can get out of the way.
 Yes, and in fact, the other thing the rendezvous server does is it also provides the public IP, because I mean, generally, you know, you could look at the email headers or flam or, you know, each person could check their routers to, to like look at the configuration of the router
 to see what his current public IP was, or for example, you could do something like you shields up at GRC, which will show you your, your public facing IP, even if your own computer is, is in a private network.
 Because that's what it is that shields up as testing.
 So there are, there are ways you could find out what your public IP is, but they're pretty techy and hairy.
 So the beauty of this rendezvous server is when two people send their traffic both to it, it sees the IP from which their traffic came and the port from which their traffic came.
 That information, it swaps and provides to the other party that then sends their traffic to that port and IP a couple times.
 And, and what will happen is the net router sees it, thinks it's, it's, it's expected and lets it right back through.
 Amazing.
 It's just cool. Now, the problem is, because from now, so now we've, now we've laid down how it's possible to connect two people both behind that routers.
 Well, what if a net router is hostile to that?
 That is to say what this requires.
 Think about it for a second. It requires that the port that, that, that, that from which the traffic was sent when you sent data to the, to the rendezvous server will not change even when data is now sent to a different IP.
 That is, it is sent to the guy you're trying to connect to, not to the rendezvous server. That is to say the, the net router has to deliberately reuse that same external port, even when the IP you're sending the data to is different.
 Not all net routers do.
 Mine, for example, doesn't. Is that nominally a good thing? I mean, obviously it's a problem here, but is, is there a reason it doesn't?
 No. And in fact, because this is causing problems, manufacturers are moving towards peer to peer friendly NAT technology. And in fact, even the formal RFC for network address translation, i.e. NAT suggests that it is better
 if the, if the public port is kept static as long as the, the internal IP and source port is remains the same.
 And that's totally for this peer to peer sharing.
 It's specifically to enable this kind of, of, of peer compatible operation. So what, so what's happening is we're seeing newer firmware versions of routers are fixing this because their customers are complaining that, you know, they can't get good Skype quality
 or good, whatever, because of these problems. So firmware upgrades are subtly changing the NAT logic so that the same outside port will be used.
 Now, again, this doesn't represent a security flaw because the mapping is still dynamic. That is to say, even though this, this, the same port is being used at the moment,
 the, the port, the, the public side port is chosen because the, the, the VoIP application is running on a certain machine and, and windows assigned it a certain port, which it uses for all of its dialogue.
 So if it used a different internal port, the NAT router could and would give it a different external port.
 So it's not like any, like there's any security compromise at all. The NAT is still assigning these, these, these port mappings dynamically and only traffic coming back from an expected port and IP would be able to get back in.
 But it's just, it's, it's elegant and it's beautiful. It does require the brief services of this rendezvous server, some, something out on the net that can see both parties enabled to accept the data and exchange it so they're able to connect to each other.
 I'm wondering if there's any way to tell if your router is compatible or not. Well, it's funny you ask, because there used to be, but I found out when I was preparing to talk about this and I wanted to get some URLs handy that the, the only service that used to be available that I knew of
 apparently is gone. There was a, there was a multi-platform program called NAT Check and it was a project living over at SourceForge.net, the, the, the open source home ground, and it was, it was running on some servers at MIT.
 And there are apologies now on that page that it's no longer possible to pull up the tables that, that used to be there. It was just, it was what, it was like last summer that, that you and I talked about this on call for help Leo, and this NAT Check program worked and the tables were there.
 It's all gone. Now, I already have a bunch of stuff on my plate. I'm working on some new technology for GRC.
 I still have to get the open VPN docs done that many people are waiting for. That's, that's the next thing I'm going to do as soon as I get this other project finished, but, but doing a NAT checking service is a, I mean, it was made for GRC. It's a kind of thing I should do.
 So, so we will talk about it again when I've got that done because, but as far as I know at the moment, there is no good way to determine whether your own particular NAT router is peer-to-peer friendly and allows this, this, this, this peer-friendly NAT mapping.
 Can you assume that if your router is less than a couple of years old, that it will? No, in fact, what I remember from that table when it was online was that even recent routers were still not doing that.
 The only, the, I mean, this is a horrible, I mean, a burdensome suggestion, but if you, if you had a packet capture capability, that is, if you were running CommView or a theory or something, and we're using Skype, in fact, this is how Leo, you and I verified that we had a direct connection
 and, and we're not going through a third party was I, I saw that my packets, my VOIP packets were, were going directly to you out on my, on the public side of my NAT to your IP rather than through some third party.
 And so, so that's, if you had the ability to look at your, at your public traffic and, and you were using two NAT routers, you could tell that you had a direct connection just by seeing that the actual IP was that of the other person and not some third party that it was, that it was bouncing through.
 And if you don't, you could always check to see if there's new firmware for your router. Certainly, if there, if you're seeing this kind of problem, always keeping your router firmware up to date is, is just always a good policy.
 But I definitely saw in this original table that they were, they were showing, they had a table, a very comprehensive table of routers by make and model and version of firmware. And you could see the differences in this behavior based on firmware version.
 So it's certainly something that is tending to migrate towards offering this capability.
 And you might look in the, the release notes for various firmware releases or your current firmware release for your router to see if it mentions that. What would it, how would it describe such a thing?
 Actually, I don't recall when I was looking at routers back when we were talking about VPN stuff, I was studying router specs extensively to understand exactly which feature I never saw anything about this.
 I don't mention it. It was really annoying. On the other hand, it means there's really a need for something that'll tell people.
 It's probably why MIT stopped doing it's a thing because it was so hard to find the information.
 Yeah.
 Okay, so you won't really know if you don't have it unless you're willing to get a packet sniffer out and kind of hack at the thing.
 And it is something that I think I need to do though. So keep an eye on security now. And would you notice an improved performance? I mean, would you notice a difference?
 Well, look at the difference we had with Skype.
 And as soon as I started using a dedicated port, it really did make a difference.
 Yeah. And so there what you were doing is you were compensating for the non peer-to-peer friendliness of somebody else's NAT router.
 See, they both have to be compatible in order for this kind of connection to work.
 Right. Fascinating stuff.
 Now, how does this relate to NAT traversal?
 Well, this is NAT traversal.
 Yeah. That's sort of the formal jargon for the notion of how to solve the problem that the statefulness of NAT and the inherent firewallness of NAT brings along.
 And the idea is you open simultaneous, you do simultaneous connections outbound through each NAT router having them chosen the proper ports to send where the packet is going to be coming from.
 One interesting thing that has been suggested is that if NAT routers were logging the incoming denied traffic, then if your applications could each read the log, they would see the packets hitting the outside of the router and be able to adjust their outbound traffic so that suddenly it was expected.
 So I have the same dangers as universal plug and play.
 It wouldn't. And it's sort of an interesting hack, but it's not something that's as far as I know has ever been done or is supported now.
 So in other words, this Ronde, this concept of a Ronde vous server works on many routers, but not all routers.
 And those routers it does not work on are not going to, it's going to be difficult to use or you may not get good quality on some of these services.
 True. And what it really means is that there will always be some third party service that you're using.
 For example, Google talk uses their servers to solve the problem Skype uses their servers peer to peer networks use nodes that are open in order to help people find each other.
 So one way or another, you are using a third party in order to provide that brief glue connection that allows each router to get the information from the other one.
 Oh, so if not traversal, we're unable on both sides, you wouldn't need the third party round at all.
 Oh, no, you still do because they're blind to each other until somebody tells them how to see each other.
 And then they're able to knit a connection directly through it.
 Very interesting stuff.
 It is really, I mean, it's a cool clue that has been sort of, it's a consequence of the fact that most routers will behave themselves this way.
 And it does, you know, it allows you and me to talk as well as we can.
 It's only frustrating because we can't tell our listeners whether they have a compliant router and how to fix it or how to find out.
 At this point, what we've explained to them is why it doesn't work.
 Not how to fix it.
 If it doesn't, exactly.
 Steve Gibson, you're the greatest, always fun, always fascinating.
 We will see you next Thursday with another exciting edition.
 And of course, I do want to remind folks that we have a great sponsor and we're really happy to have them along for the ride.
 There's a Staro corporation, makers of the Staro Security Gateway, which is a fantastic piece of software free for download for home users.
 You might want to get an old computer and put it on there because it gives you great firewalling.
 You know, and I will bet that it doesn't have traversal pretty darn well.
 I haven't asked.
 You know what?
 I'm going to ask.
 Well, I think it's open source based.
 If it didn't, somebody would have fixed it by now.
 I think all of the open source maps do this correctly.
 I'm sure it does.
 And of course, if you're stuck with novel border manager, you might be interested in ASG because they offer easy migration for novel border manager users.
 ASG version 62 features a new single sign-on capability for e-directory clients and e-directory browser and a generic proxy server.
 Check out a Staro's border manager migration wiki.
 It's online at estaro.com/bordermanager or just visit www.ASTARO.com.
 While you're on the internet, make sure you check out Steve's site, grc.com.
 Not only a great place for security information like shields up, the notes to our show, securitynow.hpm.
 Actually, we can give you a new address in a second.
 But also a great place to find Spinrite, which is Steve's day job.
 In fact, a fantastic program.
 I've used it for so long.
 Well, maybe version six is fantastic.
 Maybe for about 18 years, Leo.
 Yeah, you know, I'm thinking when is the first time I used it as probably when John and I had you on the radio show probably,
 wouldn't be 18 years ago, but it'd probably be 91 or 92.
 So it's been quite a while, quite a while, and it's a fantastic program.
 And check it out.
 If you have a problem with your hard driver, you just want to maintain, make your hard drive, you know, run as efficiently as possible.
 S-P-I-N-R-I-T-E.com.
 Now, in the past, I'm sorry, .info is for the issue.
 Spinrite.com will take you there, too, but it takes you to the normal Spinrite page.
 Spinrite.info takes you to our testimonials page.
 Got it.
 And we've always said grc.com/securitynow.hpm for our show notes, but we don't have to do that anymore.
 Yeah, I added some technology to the server.
 I noticed that people were not putting .hpm or some were putting .html, and I know Leo, you have a penchant for short URLs.
 Yes.
 You know, my radio show is Leo.am.
 You know, nothing more.
 And never.html.
 So you fixed that?
 Yeah, well, I added the ability for URLs that don't include a file extension to be accepted and the server fixes them.
 That is, you know, our web server really runs at www.grc.com.
 So if someone goes to grc.com, they'll just look at the www added for them.
 Right.
 And now, if they leave off the .hpm or hpm, they'll get that added.
 So you could just do grc.com/securitynow.
 Hello, Leo.
 How long have I been on you for this?
 Well, let's see. This is episode number one, 42.
 Even before then, I always, you've been known for your obscure URLs.
 So I'm glad to hear that.
 That's great news.
 That's good.
 And it was an easy thing to do, wasn't it?
 Oh, I'm glad it's done.
 He's an old-fashioned guy, and that's what we love about him.
 Steve, we'll see you next week for some great information and security news and so forth.
 It's a must every Thursday.
 Make sure you point your podcast client, whether it's iTunes or whatever you're using,
 to securitynow's feed, which is Leo.am/podcast/sn.
 That's all you need.
 What is it?
 We're about 100,000 listeners now.
 We are every single week.
 Yep, it's fantastic.
 Thank you, Steve.
 Always a pleasure, Leo.
 We'll see you next time.
 [Music]
